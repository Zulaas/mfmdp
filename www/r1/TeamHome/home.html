<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>
<body>
<div hidden id="content">
    <div class="bg-light p-5 rounded">
        <div class="col-sm-8 mx-auto">
            <h1>ID Token Payload</h1>
            <p>from R1 requested after each interaction</p>
            <pre id="tokenPayloadR1"></pre>

            <h1>Explanation</h1>
            <p>
                This Micro-Frontend example shows the <code>window.postMessage()</code>-method which safely enables
                cross-origin
                communication between Iframes and parent elements.
                Furthermore, it demonstrates the <i>hybrid integration approach for micro-frontend based on iframes</i>,
                where HTML parts are loaded from different resource servers into the respective iframe.
            </p>

            <p>
                The Micro-Frontends should extend in height and to a <code>100%</code> width.
                Therefore, a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage"
                                class="link-primary" target="_blank">postMessage</a>
                event must be raised in the micro frontends, see <i>/www/r1/lib/js/microfrontend.js</i>.
                This is because the micro frontend encapsulated in the iframe is not allowed
                to change anything in the parent elements.
                Open the developer tools <b>F12</b> and look at the <code>console.log()</code>-statments
                of the events when navigating throw the page.
                The logs should look like this:
            </p>

            <img src="/../lib/pictures/cross-communication%20Event-Logs.png" alt="Cross-Communication Event-Logs"
                 class="py-3 rounded img-fluid">

            <p>
                The events behind this logs are caught and interpreted in <i>/www/m/lib/js/main.js</i>.
            </p>

            <p>
                When changing the page, it can also be observed that the page does not reload, but the content of the
                iframe.
                Responsible for this is the <i>/www/m/lib/js/router.js</i>.
                This checks every 100 milliseconds if the URL path has changed.
                If this has changed it adjusts the content of the iframe.
                The logs for this should look like this:
            </p>

            <img src="/../lib/pictures/route-iframe.png" alt="Route iFrame" class="py-3 rounded img-fluid">

            <p>
                Navigation throw the page and understand how the Events works.
            </p>

        </div>
    </div>
</div>
<div hidden id="errorMsg" class="container alert alert-danger mt-5" role="alert"></div>
</body>
<!-- import of bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
<!-- import of the microfrontend.js -->
<script src="/lib/js/microfrontend.js"></script>
<!-- import sha256.js -->
<script src="/lib/js/sha256.js"></script>
<!-- import tokenManager.js -->
<script src="/lib/js/iframeTokenManager.js"></script>
<!-- calls the authorize URL -->
<script>
    let iframeTokenManager = new IframeTokenManager('r1', 'http://localhost:8080');
    iframeTokenManager.loadToken().then(
        (token) => {
            fetch('/api.php', {
                mode: 'cors',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Bearer ' + token
                },
            }).then(response => {
                response.json()
            }).then(data => {
                document.getElementById("content").hidden = false;
                document.getElementById("errorMsg").hidden = true;
                document.getElementById('tokenPayloadR1').innerText = JSON.stringify(data, undefined, 2);
            })
        }
    ).catch(error => {
            console.log(error.error_code)
            document.getElementById('errorMsg').innerText = error.error;
            document.getElementById("errorMsg").hidden = false;
            document.getElementById("content").hidden = true;
        }
    );
</script>

</html>
